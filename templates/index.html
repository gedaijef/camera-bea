<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor de QR Code</title>
    <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
</head>

<body>
    <canvas id="canvas" hidden></canvas>
    <video id="video" width="100%" height="500px" style="border: 1px solid black;"></video>
    <p id="result"></p>
    <select id="cameraSelect"></select>
    <button id="startButton">Abrir Câmera</button>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }
        
        body {
            background-color: #fdfdfd;
            color: #333;
            height: 100vh;
            padding: 1rem;
        }

        p {
            margin-block: 1rem;
            font-size: 1rem;
        }
        
        button {
            outline: none;
            border: none;
            background-color: #9ed1e7;
            border-radius: .9rem;
            padding-block: .5rem;
            padding-inline: 1rem;
            font-weight: 450;
            cursor: pointer;
            transition: background-color .3s;
        }
        
        button:hover {
            background-color: #87b4c7;
        }
        
        @media only screen and (max-width: 450px) {
            h1 {
                font-size: 1rem;
            }
        
            p {
                font-size: .8rem;
            }
            button {
                font-size: .8rem;
            }
        }
        
        @media only screen and (max-width: 200px) {
            h1 {
                font-size: .7rem;
            }
            button {
                font-size: .6rem;
            }
        }
    </style>

    <script>
        // onde vamos capturar o qrcode
        const video = document.getElementById('video');

        // onde vamos mostrar o qrcode capturado
        const canvasElement = document.getElementById('canvas');

        // criando um contexto de renderização 2D para o elemento <canvas>
        // canvasElement.getContext('2d') retorna um objeto que fornece métodos e propriedades para desenhar e manipular gráficos em um contexto bidimensional.

        // o contexto 2D é utilizado para capturar o frame atual do vídeo e processar a imagem para detecção de QR Code
        const canvas = canvasElement.getContext('2d');


        // texto que fala se nenhum qrcode for detectado
        const result = document.getElementById('result');

        document.getElementById('startButton').addEventListener('click', async function () {
            // Solicita acesso à câmera
            /*const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            video.srcObject = stream;
            video.setAttribute('playsinline', true); // necessário para o iOS safari
            video.play();*/
            const cameraSelect = document.getElementById('cameraSelect');
            const selectedDeviceId = cameraSelect.value;
            startCamera(selectedDeviceId, video)

            // método do navegador que informa ao navegador que você deseja realizar uma animação e solicita que o navegador chame uma função específica para atualizar a tela na próxima vez que ele for redesenhar a tela
            requestAnimationFrame(tick);
        });

        function tick() {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {

                // disponibilizando o canvas - tela que aparece embaixo
                // canvasElement.hidden = false;
                // canvasElement.height = video.videoHeight;
                // canvasElement.width = video.videoWidth;

                // canvas.drawImage: Desenha o frame atual do vídeo no canvas.
                canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);

                // canvas.getImageData: Captura os dados de pixel do canvas para processamento.
                // imageData é um objeto que contém os dados de pixel do canvas. Foi obtido usando o método getImageData do contexto 2D.
                const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);

                // jsQR: Decodifica o QR Code dos dados da imagem.
                // imageData.data é um array contendo os valores RGBA de cada pixel na imagem.
                // imageData.width e imageData.height são as dimensões da imagem.

                // inversionAttempts: Define como a biblioteca deve lidar com a inversão de cores. 
                let code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: 'dontInvert',
                });

                // se o qrcode for detectado
                if (code) {
                    result.innerText = `Código QR detectado: ${code.data}`;

                    // Parar o vídeo
                    //video.pause();

                    // Pegando número da inscrição e a data atual
                    let nr_inscricao = code.data
                    nr_inscricao = nr_inscricao.substr(nr_inscricao.lastIndexOf('/') + 1, nr_inscricao.lastIndexOf('.html'))
                    nr_inscricao = nr_inscricao.split(".")[0]

                    let data_presenca = new Date()
                    let horas = String(data_presenca.getHours()).padStart(2, '0');
                    let minutos = String(data_presenca.getMinutes()).padStart(2, '0');
                    let segundos = String(data_presenca.getSeconds()).padStart(2, '0');
                    let hora = horas + ':' + minutos + ':' + segundos

                    // enviar dados para banco de dados
                    enviarDados(nr_inscricao, data_presenca, hora)

                    // Redirecionar para o novo index
                    window.open(code.data);
                } else {
                    result.innerText = 'Nenhum QR Code detectado.';
                }
            }
            requestAnimationFrame(tick);
        }

        function enviarDados(num, dt, h) {
            console.log("entrou na função enviarDados")
            fetch ('https://camera-1n2b.onrender.com/salvar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ "nr_inscricao": num, "data_presenca": dt, "hora": h })
            })
                .then(response => response.json())
                .then(data => {
                    console.log('Success:', data);
                })
                .catch((error) => {
                    console.log('Error:', error);
                });

        }

        // Função assíncrona para obter as câmeras disponíveis
        async function getCameras() {
            // Obtém a lista de todos os dispositivos de mídia (câmeras, microfones, etc.)
            const devices = await navigator.mediaDevices.enumerateDevices();

            // Filtra a lista para obter apenas os dispositivos de entrada de vídeo (câmeras)
            const videoDevices = devices.filter(device => device.kind === 'videoinput');

            // Obtém o elemento select onde as opções de câmera serão adicionadas
            const cameraSelect = document.getElementById('cameraSelect');

            // Para cada dispositivo de vídeo, cria uma opção no select
            videoDevices.forEach(device => {
                const option = document.createElement('option');
                option.value = device.deviceId; // Define o valor da opção como o ID do dispositivo
                option.text = device.label || `Camera ${cameraSelect.length + 1}`; // Define o texto da opção
                cameraSelect.appendChild(option); // Adiciona a opção ao select
            });
        }

        // Função assíncrona para iniciar a câmera selecionada
        async function startCamera(deviceId, video) {
            // Define as restrições para a captura de vídeo
            const constraints = {
                video: {
                    // Se um ID de dispositivo for fornecido, usa-o para selecionar a câmera específica
                    deviceId: deviceId ? { exact: deviceId } : undefined
                }
            };

            // Solicita o fluxo de mídia com as restrições definidas
            const stream = await navigator.mediaDevices.getUserMedia(constraints);

            // Define o objeto de mídia do vídeo como o fluxo obtido
            video.srcObject = stream;

            // começar o vídeo
            video.setAttribute('playsinline', true); // necessário para o iOS safari
            video.play();
        }

        getCameras()
    </script>
</body>

</html>